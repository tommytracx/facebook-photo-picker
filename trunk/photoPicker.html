<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://www.facebook.com/2008/fbml">

<head>
 <style type="text/css">
        @import "dojoroot/dijit/themes/tundra/tundra.css";
        @import "dojoroot/dojo/resources/dojo.css"
    </style>

	<!-- Pickup the FB_API_KEY and PHOTO_PICKER_DEBUG configuration values -->
	<script type="text/javascript" src="photoPickerConfig.js"></script>
    
    <!-- Initialise Dojo Javascript library -->
    <script type="text/javascript">
	    var djConfig = {
	        parseOnLoad: true,
	        isDebug: PHOTO_PICKER_DEBUG
	    };
    </script>
    
    <script type="text/javascript" src="dojoroot/dojo/dojo.js"></script>
      
    <script type="text/javascript">
        dojo.require("dojo.parser");
        dojo.require("dijit.form.FilteringSelect");
        dojo.require("dijit.form.RadioButton");
        dojo.require("dijit.form.Button");
        dojo.require("dijit.ProgressBar");
        dojo.require("dojo.data.ItemFileReadStore");
    </script>
</head>

<body>
<script src="http://static.ak.connect.facebook.com/js/api_lib/v0.4/FeatureLoader.js.php" type="text/javascript"></script>

<script type="text/javascript">
var friends = new Object();
var friendsStore;


</script>

<div class="tundra">
    <input dojoType="dijit.form.RadioButton" id="photosMine" name="photosWho" 
           checked="checked" value="mine" type="radio" onclick="dijit.byId('friendSelection').attr('disabled',true) ; displayAlbumList()"/>
           <label for="photosMine"> My Photos </label>
    <br/>
    <input dojotype="dijit.form.RadioButton" id="photosFriends" name="photosWho" 
           value="friends" type="radio" onclick="dijit.byId('friendSelection').attr('disabled',false); displayAlbumList()"/> 
           <label for="photosFriends"> Friends' Photos </label>

    <select dojoType="dijit.form.FilteringSelect"
           name="friendSelection"
           id="friendSelection"
           searchDelay=0
           onChange="friendSelectionChanged"
           disabled="disabled">
    </select>
</div>
<br/>
<div id="photoSpace"><div dojoType="dijit.ProgressBar" style="width:300px" jsId="jsProgress" id="photoLoadProgress" indeterminate="true" class="tundra"></div></div>

<script type="text/javascript">

var myAlbumCovers = "";
var friendAlbumCovers = "";

    FB_RequireFeatures(["XFBML","Api"], function(){
        FB.Facebook.init(FB_API_KEY, "crossdomain/xd_receiver.htm");

        //FB.FBDebug.isEnabled = true;
        //FB.FBDebug.logLevel = 4;
        
        var api = FB.Facebook.apiClient;
        api.requireLogin(function(exception){

        	//Get the album covers XFBML for the logged in user then, using a callback method,
        	//store them away as the logged in user's albums and display them on the page.
            getAlbumsXFBML(api.get_session().uid, function(albumCovers) {
            	myAlbumCovers = albumCovers;
            	document.getElementById("photoSpace").innerHTML = myAlbumCovers;
                FB.XFBML.Host.parseDomTree();                
            });

            api.fql_query("SELECT uid, name FROM user WHERE uid IN (SELECT uid2 FROM friend WHERE uid1 = " + api.get_session().uid + ") order by first_name", function(results, ex) {
                var friendsItems = new Array();
                for(var i = 0; i < results.length; i++) {
                    friendsItems[i] = {"uid" : results[i].uid, "name" : results[i].name};
                }

                friends = {"identifier" : "uid", "label" : "name", "items" : friendsItems};

                friendsStore = new dojo.data.ItemFileReadStore({data: friends});
                dijit.byId('friendSelection').store = friendsStore;
                dijit.byId('friendSelection').searchAttr = "name";

                //Enable the selection box now?

                //alert(dojo.toJson(friends, true, " "));
            });

        });
        
    });

    function displayAlbum(aid) {
        var api = FB.Facebook.apiClient;
        api.requireLogin(function(exception){
        	document.getElementById("photoSpace").innerHTML = "Fetching contents of album...";
	        api.fql_query("SELECT pid FROM photo WHERE aid = '" + aid + "'", function(albumPhotos) {
	            var photoDisplay = "";
	            for(var i = 0; i < albumPhotos.length; i++) {
		            var photo = albumPhotos[i];
	            	photoDisplay += "<fb:photo pid='" + photo.pid + "' size='small'></fb:photo>";
	            }
	            
	            document.getElementById("photoSpace").innerHTML = "<button dojoType='dijit.form.Button' onclick='displayAlbumList()'>Back to album list</button><br/>" + photoDisplay;
	            
	            FB.XFBML.Host.parseDomTree();
	            
	        });
        });
    }

    function displayAlbumList() {
        if(dijit.byId('photosMine').attr('checked')) {
            document.getElementById("photoSpace").innerHTML = myAlbumCovers;
        } else {
        	document.getElementById("photoSpace").innerHTML = friendAlbumCovers;
        }
        
        FB.XFBML.Host.parseDomTree();        
    }

    function friendSelectionChanged() {
        friendUID = dijit.byId('friendSelection').attr('value');

        getAlbumsXFBML(friendUID, function(albumCovers) {
            friendAlbumCovers = albumCovers;
            document.getElementById("photoSpace").innerHTML = friendAlbumCovers;
            FB.XFBML.Host.parseDomTree();                
        });
    }

    //Generate XFBML representing the albums that uid owns then call
    //afterAsyncFetchFunction with the XFBML as a parameter.
    //We use this 2nd order function callback because the album fetch
    //happens in a separate thread and we want to perform our action
    //after the thread has finished getting the album data. 
    function getAlbumsXFBML(uid, afterAsyncFetchFunction) {

    	var albumCovers = "";
    	
    	//FB.Facebook.apiClient.photos_getAlbums(uid, null, function(albums) {
    	//Executing the cut-down FQL is quicker than getting all the unnecessary details back from photos_getAlbums()
    	FB.Facebook.apiClient.fql_query("SELECT aid, cover_pid, name FROM album WHERE owner=" + uid, function(albums) {
            var photoTableWidth = 2;
            var photoTableCount = 0;

            albumCovers += "<table>";
            
            for(var i = 0; i < albums.length; i++) {
                var album = albums[i];
                if(album.cover_pid != "") {
                    if(photoTableCount % photoTableWidth == 0) {
                        if(i != photoTableCount) {
                            albumCovers += "</tr>";
                        }
                        albumCovers += "<tr>";
                    }
                    
                    albumCovers += "<td><a onclick='displayAlbum(\"" + album.aid + "\")'><fb:photo pid='" + album.cover_pid + "' size='small'></fb:photo><br/>" + album.name + "</a></td>";

                    photoTableCount++;
                } else {
                    //Ignore photos without cover pictures, they're most probably empty
                }
            }

            albumCovers += "</tr></table>";

            //Do the actions that have been specified for after the fetch has completed.
            afterAsyncFetchFunction(albumCovers);
        });
    }
    
</script>

</body>
</html>